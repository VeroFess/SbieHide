#pragma once

#include <phnt_windows.h>
#include <phnt.h>

constexpr static const ULONG64 Crc64Table[] = {
    0xF237332D89403556ULL,
    0x88EF43E5B975BC2FULL,
    0x0787D2BDE92B27A4ULL,
    0x7D5FA275D91EAEDDULL,
    0x320FD65E110183D9ULL,
    0x48D7A69621340AA0ULL,
    0xC7BF37CE716A912BULL,
    0xBD674706415F1852ULL,
    0x591FDF99E154CB23ULL,
    0x23C7AF51D161425AULL,
    0xACAF3E09813FD9D1ULL,
    0xD6774EC1B10A50A8ULL,
    0x99273AEA79157DACULL,
    0xE3FF4A224920F4D5ULL,
    0x6C97DB7A197E6F5EULL,
    0x164FABB2294BE627ULL,
    0x8F3FCC1601FE5AD7ULL,
    0xF5E7BCDE31CBD3AEULL,
    0x7A8F2D8661954825ULL,
    0x00575D4E51A0C15CULL,
    0x4F07296599BFEC58ULL,
    0x35DF59ADA98A6521ULL,
    0xBAB7C8F5F9D4FEAAULL,
    0xC06FB83DC9E177D3ULL,
    0x241720A269EAA4A2ULL,
    0x5ECF506A59DF2DDBULL,
    0xD1A7C1320981B650ULL,
    0xAB7FB1FA39B43F29ULL,
    0xE42FC5D1F1AB122DULL,
    0x9EF7B519C19E9B54ULL,
    0x119F244191C000DFULL,
    0x6B475489A1F589A6ULL,
    0x0826CD5A983CEA54ULL,
    0x72FEBD92A809632DULL,
    0xFD962CCAF857F8A6ULL,
    0x874E5C02C86271DFULL,
    0xC81E2829007D5CDBULL,
    0xB2C658E13048D5A2ULL,
    0x3DAEC9B960164E29ULL,
    0x4776B9715023C750ULL,
    0xA30E21EEF0281421ULL,
    0xD9D65126C01D9D58ULL,
    0x56BEC07E904306D3ULL,
    0x2C66B0B6A0768FAAULL,
    0x6336C49D6869A2AEULL,
    0x19EEB455585C2BD7ULL,
    0x9686250D0802B05CULL,
    0xEC5E55C538373925ULL,
    0x752E3261108285D5ULL,
    0x0FF642A920B70CACULL,
    0x809ED3F170E99727ULL,
    0xFA46A33940DC1E5EULL,
    0xB516D71288C3335AULL,
    0xCFCEA7DAB8F6BA23ULL,
    0x40A63682E8A821A8ULL,
    0x3A7E464AD89DA8D1ULL,
    0xDE06DED578967BA0ULL,
    0xA4DEAE1D48A3F2D9ULL,
    0x2BB63F4518FD6952ULL,
    0x516E4F8D28C8E02BULL,
    0x1E3E3BA6E0D7CD2FULL,
    0x64E64B6ED0E24456ULL,
    0xEB8EDA3680BCDFDDULL,
    0x9156AAFEB08956A4ULL,
    0x2D4DE990F32E1839ULL,
    0x57959958C31B9140ULL,
    0xD8FD080093450ACBULL,
    0xA22578C8A37083B2ULL,
    0xED750CE36B6FAEB6ULL,
    0x97AD7C2B5B5A27CFULL,
    0x18C5ED730B04BC44ULL,
    0x621D9DBB3B31353DULL,
    0x866505249B3AE64CULL,
    0xFCBD75ECAB0F6F35ULL,
    0x73D5E4B4FB51F4BEULL,
    0x090D947CCB647DC7ULL,
    0x465DE057037B50C3ULL,
    0x3C85909F334ED9BAULL,
    0xB3ED01C763104231ULL,
    0xC935710F5325CB48ULL,
    0x504516AB7B9077B8ULL,
    0x2A9D66634BA5FEC1ULL,
    0xA5F5F73B1BFB654AULL,
    0xDF2D87F32BCEEC33ULL,
    0x907DF3D8E3D1C137ULL,
    0xEAA58310D3E4484EULL,
    0x65CD124883BAD3C5ULL,
    0x1F156280B38F5ABCULL,
    0xFB6DFA1F138489CDULL,
    0x81B58AD723B100B4ULL,
    0x0EDD1B8F73EF9B3FULL,
    0x74056B4743DA1246ULL,
    0x3B551F6C8BC53F42ULL,
    0x418D6FA4BBF0B63BULL,
    0xCEE5FEFCEBAE2DB0ULL,
    0xB43D8E34DB9BA4C9ULL,
    0xD75C17E7E252C73BULL,
    0xAD84672FD2674E42ULL,
    0x22ECF6778239D5C9ULL,
    0x583486BFB20C5CB0ULL,
    0x1764F2947A1371B4ULL,
    0x6DBC825C4A26F8CDULL,
    0xE2D413041A786346ULL,
    0x980C63CC2A4DEA3FULL,
    0x7C74FB538A46394EULL,
    0x06AC8B9BBA73B037ULL,
    0x89C41AC3EA2D2BBCULL,
    0xF31C6A0BDA18A2C5ULL,
    0xBC4C1E2012078FC1ULL,
    0xC6946EE8223206B8ULL,
    0x49FCFFB0726C9D33ULL,
    0x33248F784259144AULL,
    0xAA54E8DC6AECA8BAULL,
    0xD08C98145AD921C3ULL,
    0x5FE4094C0A87BA48ULL,
    0x253C79843AB23331ULL,
    0x6A6C0DAFF2AD1E35ULL,
    0x10B47D67C298974CULL,
    0x9FDCEC3F92C60CC7ULL,
    0xE5049CF7A2F385BEULL,
    0x017C046802F856CFULL,
    0x7BA474A032CDDFB6ULL,
    0xF4CCE5F86293443DULL,
    0x8E14953052A6CD44ULL,
    0xC144E11B9AB9E040ULL,
    0xBB9C91D3AA8C6939ULL,
    0x34F4008BFAD2F2B2ULL,
    0x4E2C7043CAE77BCBULL,
    0x679BA004250BFCE3ULL,
    0x1D43D0CC153E759AULL,
    0x922B41944560EE11ULL,
    0xE8F3315C75556768ULL,
    0xA7A34577BD4A4A6CULL,
    0xDD7B35BF8D7FC315ULL,
    0x5213A4E7DD21589EULL,
    0x28CBD42FED14D1E7ULL,
    0xCCB34CB04D1F0296ULL,
    0xB66B3C787D2A8BEFULL,
    0x3903AD202D741064ULL,
    0x43DBDDE81D41991DULL,
    0x0C8BA9C3D55EB419ULL,
    0x7653D90BE56B3D60ULL,
    0xF93B4853B535A6EBULL,
    0x83E3389B85002F92ULL,
    0x1A935F3FADB59362ULL,
    0x604B2FF79D801A1BULL,
    0xEF23BEAFCDDE8190ULL,
    0x95FBCE67FDEB08E9ULL,
    0xDAABBA4C35F425EDULL,
    0xA073CA8405C1AC94ULL,
    0x2F1B5BDC559F371FULL,
    0x55C32B1465AABE66ULL,
    0xB1BBB38BC5A16D17ULL,
    0xCB63C343F594E46EULL,
    0x440B521BA5CA7FE5ULL,
    0x3ED322D395FFF69CULL,
    0x718356F85DE0DB98ULL,
    0x0B5B26306DD552E1ULL,
    0x8433B7683D8BC96AULL,
    0xFEEBC7A00DBE4013ULL,
    0x9D8A5E73347723E1ULL,
    0xE7522EBB0442AA98ULL,
    0x683ABFE3541C3113ULL,
    0x12E2CF2B6429B86AULL,
    0x5DB2BB00AC36956EULL,
    0x276ACBC89C031C17ULL,
    0xA8025A90CC5D879CULL,
    0xD2DA2A58FC680EE5ULL,
    0x36A2B2C75C63DD94ULL,
    0x4C7AC20F6C5654EDULL,
    0xC31253573C08CF66ULL,
    0xB9CA239F0C3D461FULL,
    0xF69A57B4C4226B1BULL,
    0x8C42277CF417E262ULL,
    0x032AB624A44979E9ULL,
    0x79F2C6EC947CF090ULL,
    0xE082A148BCC94C60ULL,
    0x9A5AD1808CFCC519ULL,
    0x153240D8DCA25E92ULL,
    0x6FEA3010EC97D7EBULL,
    0x20BA443B2488FAEFULL,
    0x5A6234F314BD7396ULL,
    0xD50AA5AB44E3E81DULL,
    0xAFD2D56374D66164ULL,
    0x4BAA4DFCD4DDB215ULL,
    0x31723D34E4E83B6CULL,
    0xBE1AAC6CB4B6A0E7ULL,
    0xC4C2DCA48483299EULL,
    0x8B92A88F4C9C049AULL,
    0xF14AD8477CA98DE3ULL,
    0x7E22491F2CF71668ULL,
    0x04FA39D71CC29F11ULL,
    0xB8E17AB95F65D18CULL,
    0xC2390A716F5058F5ULL,
    0x4D519B293F0EC37EULL,
    0x3789EBE10F3B4A07ULL,
    0x78D99FCAC7246703ULL,
    0x0201EF02F711EE7AULL,
    0x8D697E5AA74F75F1ULL,
    0xF7B10E92977AFC88ULL,
    0x13C9960D37712FF9ULL,
    0x6911E6C50744A680ULL,
    0xE679779D571A3D0BULL,
    0x9CA10755672FB472ULL,
    0xD3F1737EAF309976ULL,
    0xA92903B69F05100FULL,
    0x264192EECF5B8B84ULL,
    0x5C99E226FF6E02FDULL,
    0xC5E98582D7DBBE0DULL,
    0xBF31F54AE7EE3774ULL,
    0x30596412B7B0ACFFULL,
    0x4A8114DA87852586ULL,
    0x05D160F14F9A0882ULL,
    0x7F0910397FAF81FBULL,
    0xF06181612FF11A70ULL,
    0x8AB9F1A91FC49309ULL,
    0x6EC16936BFCF4078ULL,
    0x141919FE8FFAC901ULL,
    0x9B7188A6DFA4528AULL,
    0xE1A9F86EEF91DBF3ULL,
    0xAEF98C45278EF6F7ULL,
    0xD421FC8D17BB7F8EULL,
    0x5B496DD547E5E405ULL,
    0x21911D1D77D06D7CULL,
    0x42F084CE4E190E8EULL,
    0x3828F4067E2C87F7ULL,
    0xB740655E2E721C7CULL,
    0xCD9815961E479505ULL,
    0x82C861BDD658B801ULL,
    0xF8101175E66D3178ULL,
    0x7778802DB633AAF3ULL,
    0x0DA0F0E58606238AULL,
    0xE9D8687A260DF0FBULL,
    0x930018B216387982ULL,
    0x1C6889EA4666E209ULL,
    0x66B0F92276536B70ULL,
    0x29E08D09BE4C4674ULL,
    0x5338FDC18E79CF0DULL,
    0xDC506C99DE275486ULL,
    0xA6881C51EE12DDFFULL,
    0x3FF87BF5C6A7610FULL,
    0x45200B3DF692E876ULL,
    0xCA489A65A6CC73FDULL,
    0xB090EAAD96F9FA84ULL,
    0xFFC09E865EE6D780ULL,
    0x8518EE4E6ED35EF9ULL,
    0x0A707F163E8DC572ULL,
    0x70A80FDE0EB84C0BULL,
    0x94D09741AEB39F7AULL,
    0xEE08E7899E861603ULL,
    0x616076D1CED88D88ULL,
    0x1BB80619FEED04F1ULL,
    0x54E8723236F229F5ULL,
    0x2E3002FA06C7A08CULL,
    0xA15893A256993B07ULL,
    0xDB80E36A66ACB27EULL,
};

__forceinline constexpr ULONG64 Crc64Runtime(const ULONG64 Init, PBYTE Buffer, SIZE_T Length) {
    ULONG64 Crc = Init;

    for (SIZE_T i = 0; i < Length; i++) {
        UINT8 byte = Buffer[i];
        Crc        = ((Crc64Table[(UINT8)Crc ^ byte] ^ 0xF237332D89403556)) ^ (Crc >> 8);
    }

    return Crc;
}

template<SIZE_T Length>
__forceinline constexpr static ULONG64 Crc64(ULONG64 Init, char const (&Data)[Length]) {
    ULONG64 Crc = Init;

    for (SIZE_T i = 0; i < Length - 1; i++) {
        UINT8 byte = Data[i];
        Crc        = ((Crc64Table[(UINT8)Crc ^ byte] ^ 0xF237332D89403556)) ^ (Crc >> 8);
    }

    return Crc;
}
